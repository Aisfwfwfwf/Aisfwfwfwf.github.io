<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сырниковый Рай</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #222222);
            padding: 10px;
            font-size: 16px;
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
            color: var(--tg-theme-text-color, #222222);
        }

        .header p {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }

        .banner {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .banner img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .products {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 70px;
        }

        .product-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .product-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--tg-theme-text-color, #222222);
            line-height: 1.2;
        }

        .product-description {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.3;
            flex-grow: 1;
        }

        .product-price {
            font-weight: bold;
            color: var(--tg-theme-button-color, #40a7e3);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .product-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: auto;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity {
            margin: 0 10px;
            font-weight: 600;
            font-size: 14px;
            min-width: 20px;
        }

        .cart-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .cart-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
        }

        .cart-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .cart-content {
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #eeeeee);
        }

        .cart-total {
            font-weight: bold;
            text-align: right;
            margin: 15px 0;
            font-size: 18px;
        }

        .order-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .close-cart {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 10px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #222222);
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 15px;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #222222);
            font-size: 14px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #dddddd);
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #f8f8f8);
            color: var(--tg-theme-text-color, #222222);
            font-size: 16px;
        }

        .input-group input.error,
        .input-group select.error,
        .input-group textarea.error {
            border-color: #ff4444;
            background-color: #fffafa;
        }

        .error-message {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .cart-empty {
            text-align: center;
            color: var(--tg-theme-hint-color, #999999);
            padding: 20px;
            font-style: italic;
        }

        @media (max-width: 400px) {
            .products {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .product-card {
                padding: 10px;
            }
            
            .product-image {
                height: 100px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .header p {
                font-size: 13px;
            }
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>Сырниковый Рай</h1>
            <p>Вкуснейшие сырники с доставкой</p>
        </header>

        <section class="banner">
            <img src="https://github.com/Aisfwfwfwf/Aisfwfwfwf.github.io/raw/main/logo.jpg" alt="Сырниковый Рай" id="bannerImage" onerror="this.src='https://img.freepik.com/free-photo/plate-with-tasty-cheesecakes-sour-cream_2829-12060.jpg'">
        </section>

        <main class="products" id="productsList"></main>

        <div class="cart-footer">
            <button class="cart-button" id="cartButton">Корзина (0)</button>
        </div>

        <div class="cart-popup" id="cartPopup">
            <div class="cart-content">
                <h2>Ваша корзина</h2>
                <div class="cart-items" id="cartItems"></div>
                <div class="cart-total">Итого: <span id="totalPrice">0</span> руб.</div>
                <button class="order-button" id="orderButton">Оформить заказ</button>
                <button class="close-cart" id="closeCart">Закрыть</button>
            </div>
        </div>

        <div class="cart-popup" id="orderPopup">
            <div class="cart-content">
                <h2>Оформление заказа</h2>
                <form id="orderForm">
                    <div class="input-group">
                        <label for="userName">Ваше имя:</label>
                        <input type="text" id="userName" required placeholder="Как к вам обращаться?">
                        <div class="error-message" id="userNameError">Пожалуйста, укажите ваше имя</div>
                    </div>
                    
                    <div class="input-group">
                        <label for="userPhone">Телефон:</label>
                        <input type="tel" id="userPhone" required placeholder="+7 (900) 123-45-67" inputmode="tel">
                        <div class="error-message" id="userPhoneError">Введите корректный номер телефона</div>
                    </div>
                    
                    <div class="input-group">
                        <label>Способ получения:</label>
                        <select id="deliveryType" required>
                            <option value="" disabled selected>Выберите способ</option>
                            <option value="delivery">Доставка (+200 руб.)</option>
                            <option value="pickup">Самовывоз</option>
                        </select>
                        <div class="error-message" id="deliveryTypeError">Пожалуйста, выберите способ получения</div>
                    </div>
                    
                    <div class="input-group" id="addressField" style="display: none;">
                        <label for="userAddress">Адрес доставки:</label>
                        <input type="text" id="userAddress" placeholder="Улица, дом, квартира">
                        <div class="error-message" id="userAddressError">Пожалуйста, укажите адрес доставки</div>
                    </div>
                    
                    <div class="input-group">
                        <label for="userComment">Комментарий к заказу:</label>
                        <textarea id="userComment" placeholder="Например: позвонить за час до доставки"></textarea>
                    </div>
                    
                    <div class="cart-total">Итого к оплате: <span id="finalPrice">0</span> руб.</div>
                </form>
                
                <button class="order-button" id="confirmOrderButton">Подтвердить заказ</button>
                <button class="close-cart" id="backToCartButton">Назад в корзину</button>
            </div>
        </div>
    </div>

    <script>
        class CheesecakeApp {
            constructor() {
                this.tg = window.Telegram?.WebApp;
                this.cart = {};
                this.products = [];
                this.deliveryCost = 200;
                this.isInitialized = false;

                this.initializeElements();
                this.loadProductsData();
            }

            initializeElements() {
                this.elements = {
                    productsList: document.getElementById('productsList'),
                    cartButton: document.getElementById('cartButton'),
                    cartPopup: document.getElementById('cartPopup'),
                    cartItems: document.getElementById('cartItems'),
                    totalPrice: document.getElementById('totalPrice'),
                    orderButton: document.getElementById('orderButton'),
                    closeCart: document.getElementById('closeCart'),
                    orderPopup: document.getElementById('orderPopup'),
                    deliveryType: document.getElementById('deliveryType'),
                    addressField: document.getElementById('addressField'),
                    finalPrice: document.getElementById('finalPrice'),
                    confirmOrderButton: document.getElementById('confirmOrderButton'),
                    backToCartButton: document.getElementById('backToCartButton'),
                    userName: document.getElementById('userName'),
                    userPhone: document.getElementById('userPhone'),
                    userAddress: document.getElementById('userAddress'),
                    userComment: document.getElementById('userComment'),
                    userNameError: document.getElementById('userNameError'),
                    userPhoneError: document.getElementById('userPhoneError'),
                    deliveryTypeError: document.getElementById('deliveryTypeError'),
                    userAddressError: document.getElementById('userAddressError')
                };
            }

            loadProductsData() {
                this.products = [
                    {
                        id: 1,
                        name: "Классические сырники",
                        description: "С нежной сметаной и ванилью",
                        price: 250,
                        image: "https://github.com/Aisfwfwfwf/Aisfwfwfwf.github.io/raw/main/1.jpg",
                        backupImage: "https://img.freepik.com/free-photo/syrniki-with-sour-cream_2829-11139.jpg"
                    },
                    {
                        id: 2,
                        name: "Сырники с шоколадом", 
                        description: "С кусочками черного шоколада",
                        price: 280,
                        image: "https://github.com/Aisfwfwfwf/Aisfwfwfwf.github.io/raw/main/2.jpg",
                        backupImage: "https://img.freepik.com/free-photo/chocolate-cheesecakes_144627-566.jpg"
                    },
                    {
                        id: 3,
                        name: "Сырники с изюмом",
                        description: "Сочные с виноградным изюмом",
                        price: 270,
                        image: "https://github.com/Aisfwfwfwf/Aisfwfwfwf.github.io/raw/main/3.jpg",
                        backupImage: "https://img.freepik.com/free-photo/raisin-cheesecakes_144627-565.jpg"
                    },
                    {
                        id: 4,
                        name: "Веганские сырники",
                        description: "На кокосовых сливках без яиц",
                        price: 300,
                        image: "https://github.com/Aisfwfwfwf/Aisfwfwfwf.github.io/raw/main/4.jpg",
                        backupImage: "https://img.freepik.com/free-photo/vegan-cheesecakes_144627-567.jpg"
                    }
                ];
            }

            async init() {
                if (this.isInitialized) return;
                this.isInitialized = true;

                if (this.tg) {
                    this.tg.expand();
                    this.tg.enableClosingConfirmation();
                }

                await this.renderProducts();
                this.setupEventListeners();
                this.updateCart();
            }

            async renderProducts() {
                this.elements.productsList.innerHTML = '';
                
                for (const product of this.products) {
                    const workingImage = await this.getWorkingImage(product);
                    
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <img src="${workingImage}" alt="${product.name}" class="product-image" 
                             onerror="this.src='${product.backupImage}'">
                        <div class="product-title">${product.name}</div>
                        <div class="product-description">${product.description}</div>
                        <div class="product-price">${product.price} руб.</div>
                        <div class="product-controls">
                            <button class="quantity-btn" data-action="decrease" data-id="${product.id}">-</button>
                            <span class="quantity">${this.cart[product.id] || 0}</span>
                            <button class="quantity-btn" data-action="increase" data-id="${product.id}">+</button>
                        </div>
                    `;
                    this.elements.productsList.appendChild(productCard);
                }
            }

            async getWorkingImage(product) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(product.image);
                    img.onerror = () => resolve(product.backupImage);
                    img.src = product.image;
                });
            }

            setupEventListeners() {
                this.elements.productsList.addEventListener('click', (e) => {
                    const button = e.target.closest('[data-action]');
                    if (button) {
                        const productId = parseInt(button.dataset.id);
                        const action = button.dataset.action;
                        this.changeQuantity(productId, action === 'increase' ? 1 : -1);
                    }
                });

                this.elements.cartButton.addEventListener('click', () => {
                    this.elements.cartPopup.style.display = 'flex';
                });

                this.elements.closeCart.addEventListener('click', () => {
                    this.elements.cartPopup.style.display = 'none';
                });

                this.elements.orderButton.addEventListener('click', () => {
                    this.openOrderPopup();
                });

                this.elements.backToCartButton.addEventListener('click', () => {
                    this.closeOrderPopup();
                });

                this.elements.confirmOrderButton.addEventListener('click', () => {
                    this.sendDataToBot();
                });

                this.elements.deliveryType.addEventListener('change', () => {
                    this.toggleAddressField();
                    this.calculateFinalTotal();
                });

                // Валидация в реальном времени
                this.elements.userPhone.addEventListener('input', (e) => {
                    this.validatePhoneNumber(e.target.value);
                });

                this.elements.userName.addEventListener('input', (e) => {
                    this.hideError(this.elements.userNameError);
                    e.target.classList.remove('error');
                });

                this.elements.deliveryType.addEventListener('change', () => {
                    this.hideError(this.elements.deliveryTypeError);
                    this.elements.deliveryType.classList.remove('error');
                });

                this.elements.userAddress.addEventListener('input', (e) => {
                    this.hideError(this.elements.userAddressError);
                    e.target.classList.remove('error');
                });

                [this.elements.cartPopup, this.elements.orderPopup].forEach(popup => {
                    popup.addEventListener('click', (e) => {
                        if (e.target === popup) {
                            popup.style.display = 'none';
                        }
                    });
                });
            }

            // Валидация номера телефона
            validatePhoneNumber(phone) {
                const cleanedPhone = phone.replace(/\D/g, '');
                
                // Показываем/скрываем ошибку в реальном времени
                if (cleanedPhone.length >= 1) {
                    if (cleanedPhone.length < 11 || !cleanedPhone.startsWith('7') && !cleanedPhone.startsWith('8')) {
                        this.showError(this.elements.userPhoneError, 'Номер должен начинаться с 7 или 8 и содержать 11 цифр');
                        this.elements.userPhone.classList.add('error');
                    } else {
                        this.hideError(this.elements.userPhoneError);
                        this.elements.userPhone.classList.remove('error');
                    }
                } else {
                    this.hideError(this.elements.userPhoneError);
                    this.elements.userPhone.classList.remove('error');
                }

                // Форматирование номера в реальном времени
                if (cleanedPhone.length > 0) {
                    let formattedPhone = '+7';
                    
                    if (cleanedPhone.length > 1) {
                        formattedPhone += ' (' + cleanedPhone.substring(1, 4);
                    }
                    if (cleanedPhone.length > 4) {
                        formattedPhone += ') ' + cleanedPhone.substring(4, 7);
                    }
                    if (cleanedPhone.length > 7) {
                        formattedPhone += '-' + cleanedPhone.substring(7, 9);
                    }
                    if (cleanedPhone.length > 9) {
                        formattedPhone += '-' + cleanedPhone.substring(9, 11);
                    }

                    // Устанавливаем отформатированное значение, но только если пользователь не редактирует середину номера
                    if (this.elements.userPhone === document.activeElement) {
                        const cursorPosition = this.elements.userPhone.selectionStart;
                        this.elements.userPhone.value = formattedPhone;
                        
                        // Восстанавливаем позицию курсора
                        setTimeout(() => {
                            this.elements.userPhone.setSelectionRange(cursorPosition, cursorPosition);
                        }, 0);
                    }
                }
            }

            // Проверка номера телефона для валидации формы
            isValidPhoneNumber(phone) {
                const cleanedPhone = phone.replace(/\D/g, '');
                return cleanedPhone.length === 11 && (cleanedPhone.startsWith('7') || cleanedPhone.startsWith('8'));
            }

            changeQuantity(productId, delta) {
                if (!this.cart[productId]) this.cart[productId] = 0;
                this.cart[productId] += delta;
                
                if (this.cart[productId] < 0) this.cart[productId] = 0;
                
                this.updateProductQuantity(productId);
                this.updateCart();
            }

            updateProductQuantity(productId) {
                const button = this.elements.productsList.querySelector(`[data-id="${productId}"][data-action]`);
                if (button) {
                    const productCard = button.closest('.product-card');
                    const quantityElement = productCard.querySelector('.quantity');
                    if (quantityElement) {
                        quantityElement.textContent = this.cart[productId] || 0;
                    }
                }
            }

            updateCart() {
                let total = 0;
                let totalCount = 0;
                
                for (const productId in this.cart) {
                    if (this.cart[productId] > 0) {
                        const product = this.products.find(p => p.id == productId);
                        if (product) {
                            total += product.price * this.cart[productId];
                            totalCount += this.cart[productId];
                        }
                    }
                }
                
                this.elements.cartButton.textContent = `Корзина (${totalCount}) | ${total} руб.`;
                this.renderCartItems();
                this.elements.totalPrice.textContent = total;
                this.elements.finalPrice.textContent = total;
            }

            renderCartItems() {
                this.elements.cartItems.innerHTML = '';
                let isEmpty = true;
                
                for (const productId in this.cart) {
                    if (this.cart[productId] > 0) {
                        isEmpty = false;
                        const product = this.products.find(p => p.id == productId);
                        if (product) {
                            const cartItem = document.createElement('div');
                            cartItem.className = 'cart-item';
                            cartItem.innerHTML = `
                                <div>
                                    <div>${product.name}</div>
                                    <div>${product.price} руб. x ${this.cart[productId]}</div>
                                </div>
                                <div>${product.price * this.cart[productId]} руб.</div>
                            `;
                            this.elements.cartItems.appendChild(cartItem);
                        }
                    }
                }
                
                if (isEmpty) {
                    this.elements.cartItems.innerHTML = '<div class="cart-empty">Корзина пуста</div>';
                    this.elements.orderButton.style.display = 'none';
                } else {
                    this.elements.orderButton.style.display = 'block';
                }
            }

            openOrderPopup() {
                this.calculateFinalTotal();
                this.elements.orderPopup.style.display = 'flex';
                this.elements.cartPopup.style.display = 'none';
            }

            closeOrderPopup() {
                this.elements.orderPopup.style.display = 'none';
                this.elements.cartPopup.style.display = 'flex';
            }

            toggleAddressField() {
                this.elements.addressField.style.display = 
                    this.elements.deliveryType.value === 'delivery' ? 'block' : 'none';
                
                this.elements.userAddress.required = this.elements.deliveryType.value === 'delivery';
            }

            calculateFinalTotal() {
                let productsTotal = parseInt(this.elements.totalPrice.textContent) || 0;
                let delivery = this.elements.deliveryType.value === 'delivery' ? this.deliveryCost : 0;
                let finalTotal = productsTotal + delivery;
                
                this.elements.finalPrice.textContent = finalTotal;
                return finalTotal;
            }

            showError(element, message) {
                element.textContent = message;
                element.classList.add('show');
            }

            hideError(element) {
                element.classList.remove('show');
            }

            validateForm() {
                let isValid = true;

                // Валидация имени
                if (!this.elements.userName.value.trim()) {
                    this.showError(this.elements.userNameError, 'Пожалуйста, укажите ваше имя');
                    this.elements.userName.classList.add('error');
                    isValid = false;
                } else {
                    this.hideError(this.elements.userNameError);
                    this.elements.userName.classList.remove('error');
                }

                // Валидация телефона
                const phone = this.elements.userPhone.value;
                if (!phone.trim()) {
                    this.showError(this.elements.userPhoneError, 'Пожалуйста, укажите ваш телефон');
                    this.elements.userPhone.classList.add('error');
                    isValid = false;
                } else if (!this.isValidPhoneNumber(phone)) {
                    this.showError(this.elements.userPhoneError, 'Введите корректный номер телефона (11 цифр, начинается с 7 или 8)');
                    this.elements.userPhone.classList.add('error');
                    isValid = false;
                } else {
                    this.hideError(this.elements.userPhoneError);
                    this.elements.userPhone.classList.remove('error');
                }

                // Валидация способа доставки
                if (!this.elements.deliveryType.value) {
                    this.showError(this.elements.deliveryTypeError, 'Пожалуйста, выберите способ получения');
                    this.elements.deliveryType.classList.add('error');
                    isValid = false;
                } else {
                    this.hideError(this.elements.deliveryTypeError);
                    this.elements.deliveryType.classList.remove('error');
                }

                // Валидация адреса для доставки
                if (this.elements.deliveryType.value === 'delivery' && !this.elements.userAddress.value.trim()) {
                    this.showError(this.elements.userAddressError, 'Пожалуйста, укажите адрес доставки');
                    this.elements.userAddress.classList.add('error');
                    isValid = false;
                } else {
                    this.hideError(this.elements.userAddressError);
                    this.elements.userAddress.classList.remove('error');
                }

                return isValid;
            }

            sendDataToBot() {
                if (!this.validateForm()) return;

                const orderData = {
                    products: [],
                    total: this.calculateFinalTotal(),
                    deliveryType: this.elements.deliveryType.value,
                    deliveryCost: this.elements.deliveryType.value === 'delivery' ? this.deliveryCost : 0,
                    customer: {
                        name: this.elements.userName.value.trim(),
                        phone: this.elements.userPhone.value.trim(),
                        address: this.elements.userAddress.value.trim() || 'Самовывоз',
                        comment: this.elements.userComment.value.trim()
                    },
                    user: this.tg?.initDataUnsafe?.user,
                    timestamp: new Date().toISOString()
                };
                
                for (const productId in this.cart) {
                    if (this.cart[productId] > 0) {
                        const product = this.products.find(p => p.id == productId);
                        if (product) {
                            orderData.products.push({
                                id: product.id,
                                name: product.name,
                                quantity: this.cart[productId],
                                price: product.price
                            });
                        }
                    }
                }
                
                if (this.tg) {
                    this.tg.sendData(JSON.stringify(orderData));
                    this.tg.showPopup({ 
                        title: "✅ Заказ оформлен!", 
                        message: "Спасибо за заказ! Мы свяжемся с вами в ближайшее время для подтверждения." 
                    }, () => {
                        setTimeout(() => this.tg.close(), 2000);
                    });
                } else {
                    console.log('Order data:', orderData);
                    alert('Заказ оформлен! (режим тестирования)');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const app = new CheesecakeApp();
            app.init();
        });
    </script>
</body>
</html>
